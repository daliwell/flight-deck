{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "ECS cluster with single t2.small instance for flight-deck",
  "Resources": {
    "ECSInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"
        ]
      }
    },
    "ECSInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Roles": [{"Ref": "ECSInstanceRole"}]
      }
    },
    "ECSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for ECS instances",
        "VpcId": "vpc-0e8fa22c84a5c54b6",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 3001,
            "ToPort": 3001,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "ECSLaunchTemplate": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateName": "flight-deck-ecs-template",
        "LaunchTemplateData": {
          "ImageId": "ami-0c84efbfa26ac0cd5",
          "InstanceType": "t2.small",
          "IamInstanceProfile": {
            "Arn": {"Fn::GetAtt": ["ECSInstanceProfile", "Arn"]}
          },
          "SecurityGroupIds": [{"Ref": "ECSSecurityGroup"}],
          "UserData": {
            "Fn::Base64": {
              "Fn::Sub": [
                "#!/bin/bash\necho ECS_CLUSTER=${ClusterName} >> /etc/ecs/ecs.config\nyum update -y\nyum install -y ecs-init\nservice docker start\nchkconfig docker on\nservice ecs start\nchkconfig ecs on\n",
                {"ClusterName": "semantic-chunker-cluster"}
              ]
            }
          }
        }
      }
    },
    "ECSAutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "AutoScalingGroupName": "flight-deck-asg",
        "VPCZoneIdentifier": ["subnet-066d347c9a11298d2"],
        "LaunchTemplate": {
          "LaunchTemplateId": {"Ref": "ECSLaunchTemplate"},
          "Version": {"Fn::GetAtt": ["ECSLaunchTemplate", "LatestVersionNumber"]}
        },
        "MinSize": "1",
        "MaxSize": "1",
        "DesiredCapacity": "1",
        "Tags": [
          {
            "Key": "Name",
            "Value": "flight-deck-ecs-instance",
            "PropagateAtLaunch": true
          }
        ]
      }
    },
    "ECSCapacityProvider": {
      "Type": "AWS::ECS::CapacityProvider",
      "Properties": {
        "Name": "flight-deck-capacity-provider",
        "AutoScalingGroupProvider": {
          "AutoScalingGroupArn": {"Ref": "ECSAutoScalingGroup"},
          "ManagedScaling": {
            "Status": "DISABLED"
          },
          "ManagedTerminationProtection": "DISABLED"
        }
      }
    }
  },
  "Outputs": {
    "ClusterName": {
      "Value": "semantic-chunker-cluster"
    },
    "SecurityGroupId": {
      "Value": {"Ref": "ECSSecurityGroup"}
    }
  }
}